<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>線上預約｜DEMO D（Treatment-first）</title>
<style>
:root{
  --brand:#0e8f74; --brand-600:#0c7861;
  --ink:#10221c; --muted:#5a776f;
  --bg:#f4fbf9; --card:#fff; --line:#dff0eb;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif}
.container{max-width:960px;margin:16px auto;padding:0 14px}
.h1{font-weight:900;font-size:clamp(22px,4.4vw,32px);display:flex;align-items:center;gap:10px}
.logo{width:42px;height:42px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:900}

.section{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:14px}
.tt{font-weight:900;margin:6px 2px 10px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid #cde7e1;border-radius:999px;background:#fff;padding:.42rem .9rem;font-weight:800;cursor:pointer}
.chip[aria-pressed="true"]{background:#dff5ef;border-color:#bfece2;color:#0a6b57}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:640px){ .grid2{grid-template-columns:1fr} }

.box{border:1px dashed #cfe7e1;border-radius:12px;padding:10px;background:#fff}
.box strong{display:block}
.timechip{border:1px solid #d8eee8;border-radius:10px;padding:.4rem .7rem;font-weight:800;cursor:pointer;background:#fff}
.timechip[aria-pressed="true"]{background:#e9faf6}

.input{border:1px solid #cfe3dd;border-radius:12px;height:46px;padding:0 .9rem;background:#fff}
.btn{border:none;border-radius:12px;padding:1rem 1.2rem;font-weight:900;cursor:pointer}
.btn-main{background:var(--brand);color:#fff}
.btn-main:hover{background:var(--brand-600)}
.btn-ghost{background:#fff;border:1px solid #cfe3dd}
</style>
</head>
<body>
<div class="container">
  <div class="h1"><div class="logo">＋</div> 預約（DEMO D：先選療程）</div>

  <!-- 1 療程 -->
  <div class="section">
    <div class="tt">選擇療程 / 服務</div>
    <div class="row" id="svcRow"></div>
    <div class="row" id="optRow" style="margin-top:6px"></div>
    <div class="box" style="margin-top:10px">
      <strong>療程說明</strong>
      <div id="svcDesc" style="color:#47635b">請先選擇療程與選項。系統會依「耗時」自動切出可預約時段。</div>
    </div>
  </div>

  <!-- 2 醫師 / 日期 -->
  <div class="section">
    <div class="grid2">
      <div>
        <div class="tt">指定醫師（可略）</div>
        <div class="row" id="docRow"></div>
      </div>
      <div>
        <div class="tt">選擇日期</div>
        <input type="date" id="date" class="input"/>
      </div>
    </div>
  </div>

  <!-- 3 可預約時間（依耗時切片） -->
  <div class="section">
    <div class="tt">可預約時間</div>
    <div class="row" id="timeRow"></div>
    <div class="box" id="selBox" style="margin-top:10px">尚未選擇</div>
  </div>

  <!-- 4 表單 -->
  <div class="section">
    <div class="tt">填寫資料</div>
    <div class="grid2">
      <input id="name" class="input" placeholder="姓名 *"/>
      <input id="birthday" class="input" type="date" placeholder="出生年月日 *"/>
      <input id="idnum" class="input" maxlength="10" placeholder="身分證字號 *"/>
      <input id="phone" class="input" maxlength="10" inputmode="numeric" placeholder="聯絡電話 *"/>
    </div>
    <label><input type="checkbox" id="agree"/> 我已閱讀並同意預約須知</label>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-main" id="submit">送出預約</button>
      <button class="btn btn-ghost" onclick="alert('Demo：查詢/取消')">查詢/取消預約</button>
    </div>
  </div>
</div>

<script>
/* 療程（可選項/耗時分鐘） */
const SERVICES=[
  {id:'scale', name:'洗牙', desc:'一般洗牙（健保給付）。', duration:30, options:[]},
  {id:'fill',  name:'蛀牙補綴', desc:'單顆蛀牙補綴；若多顆請備註。', duration:60, options:[{id:'small',name:'小面積'},{id:'large',name:'大面積'}]},
  {id:'whiten',name:'牙齒美白', desc:'門診美白療程。', duration:90, options:[]},
];
const DOCTORS=[{id:'cheng',name:'陳萬龍 醫師'},{id:'tsai',name:'蔡怡君 醫師'}];

/* 醫師可看診範圍（weekday/診段）→ 這裡簡化成「日期 → 可用時段區間」 */
const DAY_OPEN={
  // yyyy-mm-dd: [{start:'09:30', end:'12:00'},{start:'14:00',end:'17:00'}]
  '2025-09-22':[ {start:'09:30',end:'12:00'}, {start:'14:00',end:'17:00'} ],
  '2025-09-23':[ {start:'09:30',end:'12:00'} ],
  '2025-09-24':[ {start:'14:00',end:'17:00'},{start:'18:00',end:'20:00'} ],
  '2025-09-30':[ {start:'09:30',end:'12:00'},{start:'18:00',end:'20:30'} ],
};
/* 已占用（示意） */
const TAKEN={
  '2025-09-22':[{start:'10:00', end:'10:30'}], // 有人已約 30 分
};

const $=s=>document.querySelector(s);
const $svc=$('#svcRow'), $opt=$('#optRow'), $desc=$('#svcDesc'), $doc=$('#docRow'), $date=$('#date'), $times=$('#timeRow'), $sel=$('#selBox');

const state={ service:null, option:null, doctor:null, date:null, time:null };

/* UI render */
function renderServices(){
  $svc.innerHTML='';
  SERVICES.forEach(s=>{
    const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=s.name;
    if(state.service===s.id) b.setAttribute('aria-pressed','true');
    b.onclick=()=>{ state.service=s.id; state.option=null; renderServices(); renderOptions(); $desc.textContent=s.desc+`（耗時約 ${s.duration} 分鐘）`; recomputeTimes(); };
    $svc.appendChild(b);
  });
}
function renderOptions(){
  $opt.innerHTML='';
  const svc=SERVICES.find(x=>x.id===state.service);
  (svc?.options||[]).forEach(o=>{
    const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=o.name;
    if(state.option===o.id) b.setAttribute('aria-pressed','true');
    b.onclick=()=>{ state.option=o.id; renderOptions(); recomputeTimes(); };
    $opt.appendChild(b);
  });
}
function renderDocs(){
  $doc.innerHTML='';
  DOCTORS.forEach(d=>{
    const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=d.name;
    if(state.doctor===d.id) b.setAttribute('aria-pressed','true');
    b.onclick=()=>{ state.doctor=d.id; renderDocs(); recomputeTimes(); };
    $doc.appendChild(b);
  });
}

/* 時段計算：把 date 的開放區間，依「耗時」切片，排除已占用 */
function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function toStr(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function overlap(a,b){ return Math.max(a.start,b.start) < Math.min(a.end,b.end); }

function recomputeTimes(){
  $times.innerHTML=''; $sel.textContent='尚未選擇';
  if(!state.service || !$date.value) return;
  const svc=SERVICES.find(x=>x.id===state.service);
  const win=DAY_OPEN[$date.value]||[];
  if(!win.length){ $times.innerHTML='<span style="color:#7a9b93">此日不開放</span>'; return; }

  const taken=(TAKEN[$date.value]||[]).map(x=>({start:toMin(x.start),end:toMin(x.end)}));
  const dur=svc.duration;
  let result=[];

  win.forEach(seg=>{
    let start=toMin(seg.start), end=toMin(seg.end);
    for(let t=start; t+dur<=end; t+=15){  // 每15分切片
      const cand={start:t, end:t+dur};
      const hit=taken.some(o=>overlap(cand,o));
      if(!hit) result.push(cand);
    }
  });

  if(!result.length){ $times.innerHTML='<span style="color:#7a9b93">沒有可預約時段</span>'; return; }
  result.slice(0,24).forEach(c=>{
    const b=document.createElement('button'); b.className='timechip'; b.type='button';
    b.textContent=`${toStr(c.start)} ~ ${toStr(c.end)}`;
    if(state.time && state.time.start===c.start) b.setAttribute('aria-pressed','true');
    b.onclick=()=>{ state.time=c; recomputeTimes(); $sel.textContent = `已選擇：${$date.value} ｜ ${b.textContent}`; };
    $times.appendChild(b);
  });
}

/* 送出 */
$('#submit').onclick=()=>{
  const ok= state.service && $date.value && state.time && $('#name').value.trim() && $('#birthday').value && $('#idnum').value.trim() && $('#phone').value.trim() && $('#agree').checked;
  if(!ok){ alert('資料或選擇未完成'); return; }
  alert('Demo：送出成功（療程預約）');
};

/* init */
renderServices(); renderOptions(); renderDocs();
$date.addEventListener('change',()=>{ state.date=$date.value; recomputeTimes(); });
</script>
</body>
</html>
